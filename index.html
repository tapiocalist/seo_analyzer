<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO页面分析工具</title>
    <meta name="description" content="简洁的SEO页面分析工具，检测网页Title、Description、H标签、关键词密度等">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9f9f9;
            color: #202020;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            color: #644a40;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1em;
            color: #646464;
        }

        .card {
            background: #fcfcfc;
            border: 1px solid #d8d8d8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group input,
        .input-group textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            font-size: 14px;
            background: #fcfcfc;
            color: #202020;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #644a40;
            box-shadow: 0 0 0 2px rgba(100, 74, 64, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: #644a40;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #66493e;
        }

        .btn:disabled {
            background: #efefef;
            color: #646464;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #646464;
        }

        .error {
            background: #e54d2e;
            color: #ffffff;
            padding: 12px;
            border-radius: 6px;
            margin: 16px 0;
            display: none;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #644a40;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #d8d8d8;
        }

        .meta-grid {
            display: grid;
            gap: 16px;
        }

        .meta-item {
            background: #efefef;
            padding: 16px;
            border-radius: 6px;
        }

        .meta-label {
            font-weight: 600;
            color: #644a40;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .meta-value {
            color: #202020;
            word-break: break-word;
            font-size: 14px;
        }

        .status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status.good {
            background: #ffdfb5;
            color: #582d1d;
        }

        .status.warning {
            background: #ffe6c4;
            color: #582d1d;
        }

        .status.error {
            background: #e54d2e;
            color: #ffffff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: #efefef;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #644a40;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #646464;
            font-weight: 500;
        }

        .heading-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            border-left: 2px solid #644a40;
        }

        .heading-item.h1 {
            margin-left: 0;
            font-weight: normal;
        }

        .heading-item.h2 {
            margin-left: 24px;
            font-weight: normal;
        }

        .heading-level {
            background: #644a40;
            color: #ffffff;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .heading-text {
            color: #202020;
            line-height: 1.4;
            font-size: 14px;
            font-weight: normal;
        }

        .keyword-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .keyword-category {
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            overflow: hidden;
        }

        .keyword-category-header {
            background: #efefef;
            padding: 12px 16px;
            font-weight: 600;
            color: #644a40;
            border-bottom: 1px solid #d8d8d8;
        }

        .keyword-list {
            padding: 12px;
        }

        .keyword-item {
            padding: 6px 0;
            border-bottom: 1px solid #e8e8e8;
        }

        .keyword-item:last-child {
            border-bottom: none;
        }

        .keyword-text {
            font-weight: 500;
            color: #202020;
            margin-bottom: 4px;
        }

        .keyword-count {
            background: #ffdfb5;
            color: #582d1d;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }


        .batch-textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .progress-section {
            background: #e8e8e8;
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .progress-bar {
            background: #d8d8d8;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            background: #644a40;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-details {
            font-size: 12px;
            color: #646464;
            margin-top: 8px;
        }

        .no-data {
            text-align: center;
            color: #646464;
            padding: 40px;
            font-style: italic;
        }

        .supplement-section {
            margin-top: 16px;
        }

        .supplement-section h3 {
            color: #644a40;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .serp-table {
            width: 100%;
            border-collapse: collapse;
            background: #fcfcfc;
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            overflow: hidden;
        }

        .serp-table th {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #d8d8d8;
            color: #644a40;
            font-weight: 600;
            background: #efefef;
            font-size: 14px;
        }

        .serp-table td {
            padding: 8px;
            border-bottom: 1px solid #e8e8e8;
            vertical-align: top;
            font-size: 14px;
            line-height: 1.3;
        }

        .serp-table tr:last-child td {
            border-bottom: none;
        }

        .results {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .input-group {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2em;
            }

            .card > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SEO页面分析工具</h1>
            <p>分析HTML文件SEO要素：Title、Description、H标签、关键词密度</p>
        </div>

        <!-- 最近分析记录 -->
        <div id="recentHistory" class="card" style="display: none; margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #644a40; margin: 0;">最近分析记录</h3>
                <button class="btn" onclick="clearHistory()" style="background: #dc3545; font-size: 11px; padding: 4px 8px;">清空历史</button>
            </div>
            <div id="historyList" style="max-height: 120px; overflow-y: auto;"></div>
        </div>

        <!-- 批量下载HTML区域 -->
        <div class="card">
            <h3 style="margin-bottom: 12px; color: #644a40;">批量下载HTML</h3>
            <textarea id="batchUrls" class="batch-textarea" placeholder="每行一个URL：&#10;https://www.example1.com&#10;https://www.example2.com" style="height: 112px; margin-bottom: 8px;"></textarea>
            <button class="btn" onclick="batchDownload()" id="batchBtn">批量下载</button>
        </div>

        <!-- 分析HTML文件区域 -->
        <div class="card">
            <h3 style="margin-bottom: 12px; color: #644a40;">分析HTML文件</h3>
            <input type="file" id="fileInput" accept=".html,.htm" multiple style="width: 100%; padding: 12px; border: 1px solid #d8d8d8; border-radius: 6px; font-size: 14px; background: #fcfcfc; color: #202020; margin-bottom: 8px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">💡 支持多次选择文件，新选择的文件会添加到列表中（重复文件会自动跳过）</div>

            <!-- 文件列表显示区域 -->
            <div id="fileList" style="margin-bottom: 12px;"></div>

            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <button class="btn" onclick="analyzeAllFiles()" id="analyzeAllBtn" style="display: none;">分析全部</button>
                <button class="btn" onclick="copyAllToExcel()" id="copyAllBtn" style="background: #28a745; display: none;">复制全部到Excel</button>
                <button class="btn" onclick="clearCacheData()" style="background: #dc3545; font-size: 12px; padding: 8px 12px;">清除缓存</button>
            </div>
        </div>

            <div id="batchProgress" class="progress-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span id="progressText">准备下载...</span>
                    <span id="progressCount">0/0</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressDetails" class="progress-details"></div>
            </div>
        </div>

        <div class="loading">
            <p>正在分析...</p>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="results" id="results">
            <!-- 复制到Excel按钮 -->
            <div style="text-align: right; margin-bottom: 16px;">
                <button class="btn" onclick="copyToExcel()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">📋 复制到Excel</button>
            </div>

            <!-- 页面信息和标题结构并列 -->
            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <div class="meta-grid" id="basicInfo"></div>

                        <!-- 关键词指标区域 -->
                        <div id="keywordMetrics" style="margin-top: 20px;"></div>
                    </div>
                    <div>
                        <!-- 页面基本信息放在标题结构上面 -->
                        <div id="titleDescriptionInfo" style="margin-bottom: 20px;"></div>

                        <div id="headingsInfo"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 class="section-title" style="margin-bottom: 0;">关键词密度</h2>
                    <div style="color: #646464; font-size: 14px;">单词数：<span style="font-weight: 600; color: #644a40;" id="wordCountDisplay">0</span></div>
                </div>
                <div class="keyword-categories" id="keywordsInfo"></div>
            </div>

            <div id="supplementCard" class="card" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 class="section-title" style="margin-bottom: 0;">SERP竞争分析</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="copyAllUrls()" style="background: #666; font-size: 12px; padding: 6px 12px;">复制所有网址</button>
                        <button class="btn" onclick="batchDownloadSerpUrls()" style="background: #644a40; font-size: 12px; padding: 6px 12px;">批量下载HTML</button>
                    </div>
                </div>
                <div id="supplementInfo"></div>

                <!-- SERP下载进度显示 -->
                <div id="serpProgress" class="progress-section" style="display: none; margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span id="serpProgressText">准备下载...</span>
                        <span id="serpProgressCount">0/0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="serpProgressFill" class="progress-fill"></div>
                    </div>
                    <div id="serpProgressDetails" class="progress-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function analyzeFile() {
            const fileInput = document.getElementById('fileInput');

            if (!fileInput.files || fileInput.files.length === 0) {
                showError('请选择HTML文件');
                return;
            }

            const file = fileInput.files[0];

            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                showError('请选择HTML文件');
                return;
            }

            showLoading(true);

            try {
                const html = await file.text();
                const analysis = analyzePage(html, file.name);

                // 检查是否有补充信息
                const supplementData = document.getElementById('supplementDataInput').value.trim();
                let supplementInfo = null;
                if (supplementData) {
                    try {
                        supplementInfo = parseKeywordAndSerpData(supplementData);
                    } catch (error) {
                        console.warn('补充信息解析失败', error);
                    }
                }

                // 保存文件数据到localStorage
                console.log('准备保存文件数据:', file.name);
                saveFileData(file.name, html, {
                    analysis: analysis,
                    supplementInfo: supplementInfo
                });

                // 保存到历史记录
                const url = analysis.basicInfo?.url || '';
                const title = analysis.basicInfo?.title || file.name;
                const supplementText = document.getElementById('supplementDataInput').value.trim();
                saveToHistory(file.name, url, title, {
                    analysis: analysis,
                    supplementInfo: supplementInfo
                }, supplementText);

                displayResults(analysis, supplementInfo);
            } catch (error) {
                showError('文件读取失败');
            } finally {
                showLoading(false);
            }
        }



        function analyzePage(html, url) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const analysis = {
                url: url,
                title: '',
                description: '',
                h1: [],
                headings: [],
                wordCount: 0,
                charCount: 0,
                keywords: {},
                images: 0,
                links: 0
            };

            // 基础信息
            const titleEl = doc.querySelector('title');
            analysis.title = titleEl ? titleEl.textContent.trim() : '';

            const descEl = doc.querySelector('meta[name="description"]');
            analysis.description = descEl ? descEl.getAttribute('content').trim() : '';

            const h1Elements = doc.querySelectorAll('h1');
            analysis.h1 = Array.from(h1Elements).map(el => el.textContent.trim()).filter(text => text);

            // 标题结构 (H1-H2标签按页面出现顺序展示)
            const allHeadings = doc.querySelectorAll('h1, h2');
            analysis.headings = Array.from(allHeadings).map(heading => {
                const level = parseInt(heading.tagName.substring(1));
                const text = heading.textContent.trim();
                return { level, text };
            }).filter(heading => heading.text);

            // 文本分析 - 只分析可见文本内容，排除脚本和样式
            let visibleText = '';

            // 获取所有可见的文本节点
            const getVisibleText = (element) => {
                let text = '';

                if (!element) return text;

                // 跳过不可见元素
                const tagName = element.tagName ? element.tagName.toLowerCase() : '';
                if (['script', 'style', 'noscript', 'meta', 'link', 'head'].includes(tagName)) {
                    return text;
                }

                // 如果是文本节点
                if (element.nodeType === Node.TEXT_NODE) {
                    return element.textContent.trim();
                }

                // 递归处理子节点
                for (const child of element.childNodes) {
                    text += ' ' + getVisibleText(child);
                }

                return text;
            };

            visibleText = getVisibleText(doc.body || doc);
            const cleanText = visibleText.replace(/\s+/g, ' ').trim();

            analysis.wordCount = cleanText ? cleanText.split(' ').filter(word => word.length > 0).length : 0;
            analysis.charCount = cleanText.length;

            // 关键词分析 - 只分析可见文本内容
            if (cleanText) {
                const words = cleanText.toLowerCase()
                    .replace(/[^\w\s\u4e00-\u9fff]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length >= 2);

                // 单词
                const singleWords = {};
                words.forEach(word => {
                    singleWords[word] = (singleWords[word] || 0) + 1;
                });

                // 2词组合
                const twoWordPhrases = {};
                for (let i = 0; i < words.length - 1; i++) {
                    const phrase = `${words[i]} ${words[i + 1]}`;
                    twoWordPhrases[phrase] = (twoWordPhrases[phrase] || 0) + 1;
                }

                // 3词组合
                const threeWordPhrases = {};
                for (let i = 0; i < words.length - 2; i++) {
                    const phrase = `${words[i]} ${words[i + 1]} ${words[i + 2]}`;
                    threeWordPhrases[phrase] = (threeWordPhrases[phrase] || 0) + 1;
                }

                // 4词组合
                const fourWordPhrases = {};
                for (let i = 0; i < words.length - 3; i++) {
                    const phrase = `${words[i]} ${words[i + 1]} ${words[i + 2]} ${words[i + 3]}`;
                    fourWordPhrases[phrase] = (fourWordPhrases[phrase] || 0) + 1;
                }


                const processKeywords = (wordFreq, totalCount, limit = 5) => {
                    return Object.entries(wordFreq)
                        .filter(([word, count]) => count > 1)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, limit)
                        .map(([word, count]) => ({
                            word,
                            count,
                            density: ((count / totalCount) * 100).toFixed(2)
                        }));
                };

                analysis.keywords = {
                    single: processKeywords(singleWords, words.length, 5),
                    double: processKeywords(twoWordPhrases, words.length - 1, 5),
                    triple: processKeywords(threeWordPhrases, words.length - 2, 5),
                    quadruple: processKeywords(fourWordPhrases, words.length - 3, 5)
                };
            }

            analysis.images = doc.querySelectorAll('img').length;
            analysis.links = doc.querySelectorAll('a').length;

            return analysis;
        }

        function displayResults(analysis, supplementInfo = null) {
            // 基础信息和关键词信息
            const basicInfoDiv = document.getElementById('basicInfo');
            let basicInfoHTML = '';

            // 如果有关键词信息，先显示关键词和URL
            if (supplementInfo && supplementInfo.keywordInfo) {
                const kw = supplementInfo.keywordInfo;
                basicInfoHTML += `
                    <div class="meta-item">
                        <div class="meta-label">关键词：<span style="font-weight: normal; color: #202020; margin-left: 8px;">${kw.keyword}</span></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">URL：<span style="font-weight: normal; margin-left: 8px;"><a href="${kw.url}" target="_blank" style="color: #644a40; text-decoration: underline; word-break: break-all; font-size: 12px;">${kw.url}</a></span></div>
                    </div>
                `;

                // 只在搜索量不为0时显示
                if (kw.searchVolume && parseInt(kw.searchVolume) > 0) {
                    basicInfoHTML += `
                        <div class="meta-item">
                            <div class="meta-label">搜索量：<span style="font-weight: normal; color: #202020; margin-left: 8px;">${parseInt(kw.searchVolume).toLocaleString()}</span></div>
                        </div>
                    `;
                }

                basicInfoHTML += `
                    <div class="meta-item">
                        <div class="meta-label">获得流量：<span style="font-weight: normal; color: #202020; margin-left: 8px;">${kw.traffic}</span></div>
                    </div>
                `;
            }

            basicInfoDiv.innerHTML = basicInfoHTML;


            // 标题结构 (文章大纲风格)
            const headingsDiv = document.getElementById('headingsInfo');
            if (analysis.headings.length > 0) {
                headingsDiv.innerHTML = analysis.headings.map(heading => `
                    <div class="heading-item h${heading.level}">
                        <span class="heading-level">H${heading.level}</span>
                        <span class="heading-text">${heading.text}</span>
                    </div>
                `).join('');
            } else {
                headingsDiv.innerHTML = '<div class="no-data">未找到标题标签</div>';
            }

            // 关键词密度
            const keywordsDiv = document.getElementById('keywordsInfo');
            if (analysis.keywords && Object.values(analysis.keywords).some(arr => arr.length > 0)) {
                const generateKeywordCategory = (keywords, title) => {
                    if (keywords.length === 0) {
                        return `
                            <div class="keyword-category">
                                <div class="keyword-category-header">${title}</div>
                                <div class="no-data">暂无数据</div>
                            </div>
                        `;
                    }
                    
                    const keywordItems = keywords.map(keyword => `
                        <div class="keyword-item">
                            <div class="keyword-text">${keyword.word}</div>
                            <span class="keyword-count">${keyword.count}次</span>
                        </div>
                    `).join('');

                    return `
                        <div class="keyword-category">
                            <div class="keyword-category-header">${title}</div>
                            <div class="keyword-list">${keywordItems}</div>
                        </div>
                    `;
                };

                keywordsDiv.innerHTML = `
                    ${generateKeywordCategory(analysis.keywords.single, '1词')}
                    ${generateKeywordCategory(analysis.keywords.double, '2词')}
                    ${generateKeywordCategory(analysis.keywords.triple, '3词')}
                    ${generateKeywordCategory(analysis.keywords.quadruple, '4词')}
                `;
            } else {
                keywordsDiv.innerHTML = '<div class="no-data">未找到关键词数据</div>';
            }

            // 显示页面标题和描述
            const titleDescDiv = document.getElementById('titleDescriptionInfo');
            titleDescDiv.innerHTML = `
                <div class="meta-item" style="margin-bottom: 8px;">
                    <div class="meta-label">页面标题${getStatusBadge(analysis.title, 'title')}</div>
                    <div class="meta-value">${analysis.title || '未找到'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">页面描述${getStatusBadge(analysis.description, 'description')}</div>
                    <div class="meta-value">${analysis.description || '未找到'}</div>
                </div>
            `;

            // 显示关键词指标
            const keywordMetricsDiv = document.getElementById('keywordMetrics');
            if (supplementInfo && supplementInfo.keywordInfo) {
                displayKeywordMetrics(supplementInfo.keywordInfo, keywordMetricsDiv);
            } else {
                keywordMetricsDiv.innerHTML = '';
            }

            // 显示补充信息
            const supplementCard = document.getElementById('supplementCard');
            const supplementDiv = document.getElementById('supplementInfo');
            if (supplementInfo && supplementInfo.serpLinks && supplementInfo.serpLinks.length > 0) {
                displaySupplementInfo(supplementInfo, supplementDiv);
                supplementCard.style.display = 'block';
            } else {
                supplementCard.style.display = 'none';
            }

            // 更新单词数显示
            const wordCountDisplay = document.getElementById('wordCountDisplay');
            if (wordCountDisplay) {
                wordCountDisplay.textContent = analysis.wordCount;
            }

            document.getElementById('results').style.display = 'block';
        }

        function getStatusBadge(value, type) {
            switch (type) {
                case 'title':
                    if (!value) return '<span class="status error">缺失</span>';
                    if (value.length < 30) return '<span class="status warning">偏短</span>';
                    if (value.length > 60) return '<span class="status warning">偏长</span>';
                    return '<span class="status good">良好</span>';
                
                case 'description':
                    if (!value) return '<span class="status error">缺失</span>';
                    if (value.length < 120) return '<span class="status warning">偏短</span>';
                    if (value.length > 160) return '<span class="status warning">偏长</span>';
                    return '<span class="status good">良好</span>';
                
                case 'h1':
                    if (!value || value.length === 0) return '<span class="status error">缺失</span>';
                    if (value.length > 1) return '<span class="status warning">多个H1</span>';
                    return '<span class="status good">良好</span>';
                
                default:
                    return '';
            }
        }

        async function batchDownload() {
            const textarea = document.getElementById('batchUrls');
            const progressDiv = document.getElementById('batchProgress');
            const batchBtn = document.getElementById('batchBtn');
            
            const urls = textarea.value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url && url.startsWith('http'));

            if (urls.length === 0) {
                showError('请输入有效的网址列表');
                return;
            }

            progressDiv.style.display = 'block';
            batchBtn.disabled = true;
            batchBtn.textContent = '下载中...';

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressDetails = document.getElementById('progressDetails');

            let completed = 0;
            let successful = 0;
            const results = [];

            progressCount.textContent = `0/${urls.length}`;
            progressDetails.innerHTML = '';

            try {
                progressText.textContent = `开始并发下载 ${urls.length} 个链接...`;

                // 创建所有下载任务
                const downloadTasks = urls.map(async (url, i) => {
                    try {
                        const response = await fetchPageContent(url, 12000); // 12秒超时
                        const html = await response.text();

                        const urlObj = new URL(url);
                        const filename = `${urlObj.hostname}.html`;

                        downloadHTML(html, filename);
                        return { url, status: 'success', filename, html };
                    } catch (error) {
                        console.error(`下载失败 ${url}:`, error);
                        return { url, status: 'failed', error: error.message };
                    }
                });

                // 等待所有任务完成，并实时更新进度
                for (let taskIndex = 0; taskIndex < downloadTasks.length; taskIndex++) {
                    const task = downloadTasks[taskIndex];
                    const result = await task;
                    results.push(result);
                    completed++;

                    if (result.status === 'success') {
                        successful++;
                        progressDetails.innerHTML += `<div style="color: #644a40;">✓ ${result.url}</div>`;
                    } else {
                        progressDetails.innerHTML += `<div style="color: #e54d2e;">✗ ${result.url} (${result.error})</div>`;
                    }

                    progressCount.textContent = `${completed}/${urls.length}`;
                    progressFill.style.width = `${(completed / urls.length) * 100}%`;
                    progressText.textContent = `已完成: ${completed}/${urls.length}`;
                }

                progressText.textContent = `批量下载完成！成功: ${successful}个`;
                
                // 批量下载后自动分析第一个成功的文件
                if (results.length > 0) {
                    const successResult = results.find(r => r.status === 'success');
                    if (successResult) {
                        setTimeout(() => {
                            const analysis = analyzePage(successResult.html, successResult.url);

                            // 检查是否有补充信息
                            const supplementData = document.getElementById('supplementDataInput').value.trim();
                            let supplementInfo = null;
                            if (supplementData) {
                                try {
                                    supplementInfo = parseKeywordAndSerpData(supplementData);
                                } catch (error) {
                                    console.warn('补充信息解析失败', error);
                                }
                            }

                            displayResults(analysis, supplementInfo);
                        }, 1000);
                    }
                }
                
            } catch (error) {
                showError('批量下载失败: ' + error.message);
            } finally {
                batchBtn.disabled = false;
                batchBtn.textContent = '批量下载';
            }
        }

        function downloadHTML(htmlContent, filename) {
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            document.querySelector('.loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function parseSupplementData() {
            const textarea = document.getElementById('supplementData');
            const supplementInfo = document.getElementById('supplementInfo');
            const data = textarea.value.trim();

            if (!data) {
                showError('请输入补充数据');
                return;
            }

            try {
                const result = parseKeywordAndSerpData(data);
                displaySupplementInfo(result);
                supplementInfo.style.display = 'block';
            } catch (error) {
                showError('数据解析失败，请检查数据格式');
            }
        }

        function parseKeywordAndSerpData(data) {
            console.log('Starting to parse supplement data');
            const lines = data.split('\n').filter(line => line.trim());
            const result = {
                keywordInfo: null,
                serpLinks: []
            };

            let currentSection = '';
            let keywordHeaderFound = false;
            let serpLinksStarted = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // 检查是否是关键词信息开始
                if (line.includes('关键词信息') || line.toLowerCase().includes('keyword')) {
                    currentSection = 'keyword';
                    continue;
                }

                // 检查是否是SERP链接开始
                if (line.includes('SERP links') || (line.includes('URL') && line.includes('网站标题'))) {
                    currentSection = 'serp';
                    serpLinksStarted = true;
                    continue;
                }

                // 如果没有找到关键词数据，并且当前行不是tab分隔的数据，检查是否是Google格式SERP开始
                if (currentSection === '' && !keywordHeaderFound && !line.includes('\t')) {
                    // 检查接下来几行是否符合Google格式
                    let hasGoogleFormat = false;
                    for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                        const checkLine = lines[j] ? lines[j].trim() : '';
                        if (checkLine.includes('›') || checkLine.startsWith('http')) {
                            hasGoogleFormat = true;
                            break;
                        }
                    }

                    if (hasGoogleFormat) {
                        currentSection = 'serp';
                        serpLinksStarted = true;
                        // 不要回退，直接处理当前行
                    }
                }

                // 解析关键词数据
                if (currentSection === 'keyword' && line.includes('\t') && !keywordHeaderFound) {
                    const parts = line.split('\t');

                    // 跳过表头行
                    if (line.toLowerCase().includes('keyword') && line.toLowerCase().includes('difficulty')) {
                        continue;
                    }

                    // 解析数据行
                    if (parts.length >= 13) {
                        // 按照实际格式解析：
                        // 0:Keyword, 1:Position, 2:Previous position, 3:Search Volume, 4:Keyword Difficulty, 5:CPC, 6:URL, 7:Traffic, 8:Traffic (%), 9:Traffic Cost, 10:Competition, 11:Number of Results, 12:intitle
                        result.keywordInfo = {
                            keyword: parts[0] || '',
                            position: parts[1] || '',
                            difficulty: parts[4] || '',
                            results: parts[11] || '', // Number of Results
                            intitle: parts[12] || '', // intitle 结果数
                            url: parts[6] || '',
                            traffic: parts[7] || ''
                        };
                        keywordHeaderFound = true;
                        console.log('Successfully parsed keyword info:', result.keywordInfo);
                    } else {
                        console.log('Not enough parts for keyword parsing:', parts.length);
                    }
                }

                // 解析SERP链接
                if (currentSection === 'serp' && serpLinksStarted) {
                    // 如果是空行，跳过
                    if (!line) {
                        continue;
                    }

                    // 检查接下来几行是否符合Google格式
                    let isGoogleFormat = false;
                    for (let j = i + 1; j <= i + 4 && j < lines.length; j++) {
                        const nextLine = lines[j].trim();
                        if (nextLine.includes('›')) {
                            isGoogleFormat = true;
                            break;
                        }
                    }

                    if (isGoogleFormat) {
                        // Google格式：解析从当前位置开始的所有数据
                        const googleResults = parseGoogleFormat(lines, i);
                        if (googleResults.length > 0) {
                            result.serpLinks.push(...googleResults);
                        }
                        break; // 已解析完所有Google格式数据
                    } else if (line.includes('http')) {
                        // 原有格式
                        const parsed = parseSerpLine(line);
                        if (parsed) {
                            result.serpLinks.push(parsed);
                        }
                    }
                }
            }

            console.log('Parsing completed. Found', result.serpLinks.length, 'SERP links');
            return result;
        }

        function parseGoogleFormat(lines, startIndex) {
            // Google搜索结果格式解析
            // 格式：第1行-标题，第2行-网站名，第3行-URL，第4行-描述

            const results = [];
            let i = startIndex;

            while (i < lines.length - 2) {  // 至少需要3行才能形成一个条目
                const line1 = lines[i] ? lines[i].trim() : '';
                const line2 = lines[i + 1] ? lines[i + 1].trim() : '';
                const line3 = lines[i + 2] ? lines[i + 2].trim() : '';
                const line4 = lines[i + 3] ? lines[i + 3].trim() : '';

                console.log(`Checking entry starting at line ${i}:`);
                console.log(`  Line ${i}: "${line1}" (potential title)`);
                console.log(`  Line ${i + 1}: "${line2}" (potential website)`);
                console.log(`  Line ${i + 2}: "${line3}" (potential URL)`);
                console.log(`  Line ${i + 3}: "${line4}" (potential description)`);

                // 检查是否符合Google格式：第3行包含›符号
                if (line3.includes('›')) {
                    let title = line1;
                    let url = line3.replace(/\s*›\s*/g, '/');
                    url = url.replace(/\s+/g, '');

                    if (!url.startsWith('http')) {
                        url = 'https://' + url;
                    }

                    if (title && url) {
                        results.push({
                            title: title,
                            url: url
                        });
                        console.log(`  ✓ Added result: title="${title}", url="${url}"`);

                        // 跳过这个完整的条目（4行）
                        i += 4;

                        // 跳过可能的空行
                        while (i < lines.length && !lines[i].trim()) {
                            i++;
                        }
                    } else {
                        i++;
                    }
                } else {
                    // 不符合格式，继续下一行
                    i++;
                }
            }

            return results;
        }

        function parseSerpLine(line) {
            // 示例格式：https://funy.ai/ai-video/clipfly-ai-kissing-generator-free/#:~:text=Merge%20t...1ClipFly AI Kissing Generator: Create Free Kiss Videos - Funy AIFuny AIhttps:...
            // 或：https://funy.ai/ai-kissing-video-free/2AI Kissing Video Generator Online - Free & No Sign UpFuny AIhttps://funy.ai ...

            // 提取开头的URL
            const urlMatch = line.match(/^(https?:\/\/[^\s#]*[^\d])/);
            if (!urlMatch) return null;

            const url = urlMatch[1];
            let remainingText = line.replace(urlMatch[0], '').trim();

            // 移除开头可能的序号
            remainingText = remainingText.replace(/^\d+/, '').trim();

            // 查找标题：从序号后到"https"之前的内容
            let title = '';
            const httpsIndex = remainingText.indexOf('https');
            if (httpsIndex > 0) {
                title = remainingText.substring(0, httpsIndex).trim();
            } else {
                title = remainingText;
            }

            // 清理标题，移除多余的网站名称重复
            title = title.replace(/([A-Za-z\s]+)\1+$/, '$1'); // 移除重复的网站名
            title = title.replace(/\s+/g, ' ').trim(); // 规范化空格

            if (!title) return null;

            return {
                url: url,
                title: title
            };
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                updateFileStatus(file.name);
            }
        }

        function displayKeywordMetrics(keywordInfo, targetDiv) {
            const kw = keywordInfo;
            const results = parseFloat(kw.results) || 0;
            const intitle = parseFloat(kw.intitle) || 0;
            const difficulty = parseFloat(kw.difficulty) || 0;
            const traffic = parseFloat(kw.traffic) || 0;

            // 计算 KGR (Keyword Golden Ratio) = intitle / Number of Results
            let kgr = 0;
            let kgrStatus = '';
            if (results > 0) {
                kgr = (intitle / results).toFixed(4);
                if (kgr <= 0.25) kgrStatus = '🟢 优秀';
                else if (kgr <= 0.5) kgrStatus = '🟡 良好';
                else if (kgr <= 1) kgrStatus = '🟠 一般';
                else kgrStatus = '🔴 较差';
            } else {
                kgr = 'N/A';
                kgrStatus = '无法计算';
            }

            targetDiv.innerHTML = `
                <h3 style="color: #644a40; margin-bottom: 8px; font-size: 1em;">关键词指标</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px;">
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">搜索结果数量</div>
                        <div style="font-weight: 600; color: #644a40; font-size: 14px;">${kw.results ? parseInt(kw.results).toLocaleString() : '0'}</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">Intitle</div>
                        <div style="font-weight: 600; color: #644a40; font-size: 14px;">${kw.intitle ? parseInt(kw.intitle).toLocaleString() : '0'}</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">KD难度</div>
                        <div style="font-weight: 600; color: #644a40; font-size: 14px;">${kw.difficulty}</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">KGR</div>
                        <div style="font-weight: 600; color: #644a40; font-size: 14px;">${kgr}</div>
                    </div>
                </div>
            `;
        }

        function displaySupplementInfo(data) {
            const supplementDiv = document.getElementById('supplementInfo');
            let html = '';

            // 保存SERP链接数据到全局变量
            globalSerpLinks = data.serpLinks || [];


            // SERP链接表格（无标题）
            if (data.serpLinks.length > 0) {
                html += `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: #fcfcfc; border: 1px solid #d8d8d8; border-radius: 6px;">
                            <thead>
                                <tr style="background: #efefef;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #d8d8d8; color: #644a40; font-weight: 600; font-size: 14px;">#</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #d8d8d8; color: #644a40; font-weight: 600; font-size: 14px;">标题</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #d8d8d8; color: #644a40; font-weight: 600; font-size: 14px;">网址</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.serpLinks.forEach((link, index) => {
                    html += `
                        <tr style="border-bottom: 1px solid #e8e8e8;" id="serp-row-${index}">
                            <td style="padding: 8px; font-weight: 600; color: #644a40; font-size: 14px; line-height: 1.3;">${index + 1}</td>
                            <td style="padding: 8px; color: #202020; line-height: 1.3; font-size: 14px;">${link.title}</td>
                            <td style="padding: 8px; font-size: 14px; line-height: 1.3;">
                                <a href="${link.url}" target="_blank" style="color: #644a40; text-decoration: underline; word-break: break-all;">${link.url}</a>
                                <span id="download-status-${index}" style="margin-left: 8px; color: #28a745; font-weight: bold;"></span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            supplementDiv.innerHTML = html;
        }

        function testParseData() {
            const data = document.getElementById('supplementDataInput').value.trim();
            if (!data) {
                alert('请先输入补充数据');
                return;
            }

            console.log('=== 开始测试解析 ===');
            try {
                const result = parseKeywordAndSerpData(data);
                console.log('=== 解析结果 ===', result);
                alert(`解析结果：\n关键词: ${result.keywordInfo?.keyword || '未找到'}\n结果数: ${result.keywordInfo?.results || '未找到'}\nSERP链接: ${result.serpLinks?.length || 0}个\n\n请查看控制台获取详细信息`);
            } catch (error) {
                console.error('解析失败:', error);
                alert('解析失败，请查看控制台获取详细信息');
            }
        }

        // 全局变量存储SERP链接数据
        let globalSerpLinks = [];

        // 数据持久化相关函数
        const STORAGE_KEY = 'seo_analyzer_data';
        const HISTORY_KEY = 'seo_analyzer_history';
        const STORAGE_EXPIRY_DAYS = 7;
        const MAX_HISTORY_RECORDS = 10;

        function saveToStorage(data) {
            try {
                const storageData = {
                    ...data,
                    timestamp: Date.now(),
                    expiryTime: Date.now() + (STORAGE_EXPIRY_DAYS * 24 * 60 * 60 * 1000)
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(storageData));
                console.log('数据已保存到localStorage:', Object.keys(data));
            } catch (error) {
                console.warn('保存到localStorage失败:', error);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return null;

                const data = JSON.parse(stored);

                // 检查是否过期
                if (data.expiryTime && Date.now() > data.expiryTime) {
                    localStorage.removeItem(STORAGE_KEY);
                    console.log('localStorage数据已过期，已清除');
                    return null;
                }

                return data;
            } catch (error) {
                console.warn('从localStorage读取失败:', error);
                return null;
            }
        }

        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            console.log('localStorage数据已清除');
        }

        function saveFileData(fileName, fileContent, analysisResult = null) {
            const currentData = loadFromStorage() || {};
            const fileData = {
                uploadedFile: {
                    name: fileName,
                    content: fileContent,
                    uploadTime: Date.now()
                }
            };

            if (analysisResult) {
                fileData.analysisResults = analysisResult;
            }

            saveToStorage({
                ...currentData,
                ...fileData
            });
        }

        function saveSupplementData(supplementText, parsedData = null) {
            const currentData = loadFromStorage() || {};
            const supplementData = {
                supplementData: supplementText
            };

            if (parsedData) {
                supplementData.parsedSupplementData = parsedData;
            }

            saveToStorage({
                ...currentData,
                ...supplementData
            });
        }

        // 实时保存补充信息
        let saveTimeout;
        function saveSupplementDataOnInput() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const supplementText = document.getElementById('supplementDataInput').value.trim();
                if (supplementText) {
                    try {
                        const parsedData = parseKeywordAndSerpData(supplementText);
                        saveSupplementData(supplementText, parsedData);
                    } catch (error) {
                        saveSupplementData(supplementText);
                    }
                }
            }, 1000); // 1秒后保存，避免频繁保存
        }

        // 页面加载时恢复数据
        let dataRestored = false;
        function restoreDataOnLoad() {
            if (dataRestored) return; // 防止重复恢复

            const savedData = loadFromStorage();
            if (!savedData) return;

            console.log('恢复localStorage数据');
            let hasRestored = false;

            // 恢复上传的文件信息和分析结果
            if (savedData.uploadedFile) {
                // 创建文件状态指示器
                createFileStatusIndicator(savedData.uploadedFile.name);

                // 如果有分析结果，直接显示
                if (savedData.analysisResults) {
                    displayResults(savedData.analysisResults.analysis, savedData.analysisResults.supplementInfo);
                    hasRestored = true;
                }
            }

            // 恢复补充信息
            if (savedData.supplementData) {
                const supplementInput = document.getElementById('supplementDataInput');
                if (supplementInput) {
                    supplementInput.value = savedData.supplementData;
                    hasRestored = true;
                }
            }

            // 显示恢复提示
            if (hasRestored) {
                showRestoreNotification();
            }

            dataRestored = true; // 标记已恢复
        }

        function createFileStatusIndicator(fileName) {
            // 在文件输入框下方显示已恢复的文件状态
            const fileInput = document.getElementById('fileInput');
            let statusDiv = document.getElementById('fileRestoreStatus');

            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'fileRestoreStatus';
                fileInput.parentNode.insertBefore(statusDiv, fileInput.nextSibling);
            }

            statusDiv.innerHTML = `
                <div style="padding: 8px 12px; background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 4px; margin-top: 8px; font-size: 13px; color: #2d5a2d;">
                    ✓ 已恢复文件: <strong>${fileName}</strong>
                    <button onclick="clearRestoredFile()" style="background: none; border: none; color: #dc3545; margin-left: 10px; cursor: pointer; font-size: 12px;">清除</button>
                </div>
            `;
        }

        function clearRestoredFile() {
            const statusDiv = document.getElementById('fileRestoreStatus');
            if (statusDiv) {
                statusDiv.remove();
            }

            // 清除localStorage中的文件数据
            const currentData = loadFromStorage();
            if (currentData) {
                delete currentData.uploadedFile;
                delete currentData.analysisResults;
                saveToStorage(currentData);
            }

            // 隐藏分析结果
            document.getElementById('results').style.display = 'none';
        }

        function showRestoreNotification(message = '已恢复之前的数据') {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 14px;">
                    ✓ ${message}
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;
            document.body.appendChild(notification);

            // 3秒后自动消失
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // 清除缓存数据
        function clearCacheData() {
            clearStorage();

            // 清除界面
            document.getElementById('fileInput').value = '';
            document.getElementById('supplementDataInput').value = '';
            document.getElementById('results').style.display = 'none';

            // 清除文件恢复状态指示器
            const statusDiv = document.getElementById('fileRestoreStatus');
            if (statusDiv) {
                statusDiv.remove();
            }

            // 显示清除成功提示
            showClearNotification();
        }

        function showClearNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 14px;">
                    🗑️ 缓存数据已清除
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;
            document.body.appendChild(notification);

            // 3秒后自动消失
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // 历史记录管理
        function saveToHistory(fileName, url, title, analysisData, supplementData, timestamp = Date.now()) {
            try {
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

                // 提取网站名称（域名）
                let siteName = fileName.replace(/\.(html?|htm)$/i, '');
                if (url && url.startsWith('http')) {
                    try {
                        const urlObj = new URL(url);
                        siteName = urlObj.hostname;
                    } catch (e) {
                        console.warn('URL解析失败:', url);
                    }
                }

                console.log('保存历史记录 - 文件名:', fileName, '网站名:', siteName);

                const record = {
                    id: timestamp,
                    fileName: fileName,
                    siteName: siteName,
                    title: title || siteName,
                    url: url,
                    timestamp: timestamp,
                    // 保存完整的分析数据
                    analysisData: analysisData,
                    supplementData: supplementData
                };

                // 避免重复记录（相同网站名称）
                history = history.filter(item => item.siteName !== siteName);

                // 添加到开头
                history.unshift(record);

                // 限制记录数量
                history = history.slice(0, MAX_HISTORY_RECORDS);

                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                console.log('历史记录已保存:', siteName);

                displayHistory();
            } catch (error) {
                console.warn('保存历史记录失败:', error);
            }
        }

        function loadHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch (error) {
                console.warn('读取历史记录失败:', error);
                return [];
            }
        }

        function displayHistory() {
            const history = loadHistory();
            const historyCard = document.getElementById('recentHistory');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyCard.style.display = 'none';
                return;
            }

            historyCard.style.display = 'block';

            historyList.innerHTML = history.map((record, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-radius: 4px; background: ${index % 2 === 0 ? '#f8f8f8' : '#fff'}; margin-bottom: 2px; cursor: pointer;" onclick="loadHistoryRecord('${record.id}')">
                    <div>
                        <div style="font-weight: 600; color: #644a40; font-size: 13px;">${record.siteName}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">${new Date(record.timestamp).toLocaleString()}</div>
                    </div>
                    <button onclick="event.stopPropagation(); removeHistoryRecord('${record.id}')" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 12px; padding: 2px 4px;">×</button>
                </div>
            `).join('');
        }

        function loadHistoryRecord(recordId) {
            const history = loadHistory();
            const record = history.find(item => item.id.toString() === recordId.toString());

            if (record && record.analysisData) {
                console.log('从历史记录恢复数据:', record.siteName);

                // 创建文件状态指示器
                createFileStatusIndicator(record.fileName);

                // 恢复补充信息（如果有）
                if (record.supplementData) {
                    const supplementInput = document.getElementById('supplementDataInput');
                    if (supplementInput) {
                        supplementInput.value = record.supplementData;
                    }
                }

                // 直接显示分析结果
                displayResults(record.analysisData.analysis, record.analysisData.supplementInfo);

                // 显示恢复提示
                showRestoreNotification(`已从历史记录恢复：${record.siteName}`);
            } else {
                alert(`历史记录数据不完整，无法恢复分析结果。`);
            }
        }

        function removeHistoryRecord(recordId) {
            let history = loadHistory();
            history = history.filter(item => item.id.toString() !== recordId.toString());
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            displayHistory();
        }

        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
            displayHistory();

            // 显示清除提示
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 14px;">
                    🗑️ 历史记录已清空
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // 复制所有数据到Excel
        function copyToExcel() {
            try {
                // 获取当前分析数据
                const savedData = loadFromStorage();
                if (!savedData || !savedData.analysisResults) {
                    alert('没有可复制的分析数据');
                    return;
                }

                const analysis = savedData.analysisResults.analysis;
                const supplementInfo = savedData.analysisResults.supplementInfo;

                // 创建单行格式的Excel数据
                const headers = [
                    '关键词', 'URL', '获得流量', '搜索结果数量', 'Intitle', 'KD难度', 'KGR',
                    '页面标题', '页面描述', 'H1', 'H2', '单词数',
                    '1词', '2词', '3词', '4词',
                    'SERP竞争分析标题', 'SERP竞争分析网址'
                ];

                const dataRow = [];

                // 关键词指标
                if (supplementInfo && supplementInfo.keywordInfo) {
                    const kw = supplementInfo.keywordInfo;
                    dataRow.push(kw.keyword || ''); // 关键词
                    dataRow.push(kw.url || ''); // URL
                    dataRow.push(kw.traffic || ''); // 获得流量
                    dataRow.push(kw.results || ''); // 搜索结果数量
                    dataRow.push(kw.intitle || ''); // Intitle
                    dataRow.push(kw.difficulty || ''); // KD难度
                    dataRow.push(calculateKGR(kw.intitle, kw.results)); // KGR
                } else {
                    dataRow.push('', '', '', '', '', '', ''); // 空的关键词指标
                }

                // 页面信息
                dataRow.push(analysis.title || ''); // 页面标题
                dataRow.push(analysis.description || ''); // 页面描述

                // H标签
                const h1Tags = analysis.headings?.filter(h => h.level === 1).map(h => h.text).join('; ') || '';
                const h2Tags = analysis.headings?.filter(h => h.level === 2).map(h => h.text).join('; ') || '';
                dataRow.push(h1Tags); // H1
                dataRow.push(h2Tags); // H2

                // 单词数
                dataRow.push(analysis.wordCount || '0'); // 单词数

                // 关键词密度（按词数分组）
                const keywords1 = analysis.keywords?.single?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                const keywords2 = analysis.keywords?.double?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                const keywords3 = analysis.keywords?.triple?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                const keywords4 = analysis.keywords?.quadruple?.map(k => `${k.word}(${k.count})`).join('; ') || '';

                dataRow.push(keywords1); // 1词
                dataRow.push(keywords2); // 2词
                dataRow.push(keywords3); // 3词
                dataRow.push(keywords4); // 4词

                // SERP竞争分析
                if (supplementInfo && supplementInfo.serpLinks && supplementInfo.serpLinks.length > 0) {
                    const serpTitles = supplementInfo.serpLinks.map(link => link.title).join('; ');
                    const serpUrls = supplementInfo.serpLinks.map(link => link.url).join('; ');
                    dataRow.push(serpTitles); // SERP竞争分析标题
                    dataRow.push(serpUrls); // SERP竞争分析网址
                } else {
                    dataRow.push('', ''); // 空的SERP数据
                }

                const excelData = [headers, dataRow];

                // 转换为制表符分隔的格式
                const tsvContent = excelData.map(row => row.join('\t')).join('\n');

                // 复制到剪贴板 - 优先使用更可靠的方法
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(tsvContent).then(() => {
                            showCopySuccessNotification();
                        }).catch(err => {
                            console.warn('Clipboard API失败，使用fallback:', err);
                            fallbackCopyToClipboard(tsvContent);
                        });
                    } else {
                        fallbackCopyToClipboard(tsvContent);
                    }
                } catch (error) {
                    console.error('复制过程出错:', error);
                    fallbackCopyToClipboard(tsvContent);
                }

            } catch (error) {
                console.error('复制到Excel失败:', error);
                alert('复制失败，请重试');
            }
        }

        function getStatusText(status) {
            if (!status) return '';
            switch (status) {
                case 'good': return '良好';
                case 'warning': return '警告';
                case 'error': return '错误';
                default: return status;
            }
        }

        function calculateKGR(intitle, results) {
            const intitleNum = parseFloat(intitle) || 0;
            const resultsNum = parseFloat(results) || 0;
            if (resultsNum === 0) return 'N/A';
            return (intitleNum / resultsNum).toFixed(4);
        }

        function fallbackCopyToClipboard(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-1000px';
                textArea.style.left = '-1000px';
                textArea.style.width = '1px';
                textArea.style.height = '1px';
                textArea.style.opacity = '0';
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                textArea.setSelectionRange(0, 99999); // 对移动设备更好的支持

                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);

                if (successful) {
                    showCopySuccessNotification();
                } else {
                    // 显示一个模态框让用户手动复制
                    showManualCopyDialog(text);
                }
            } catch (err) {
                console.error('Fallback复制失败:', err);
                showManualCopyDialog(text);
            }
        }

        function showManualCopyDialog(text) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; max-height: 400px; overflow: auto;">
                        <h3 style="margin-top: 0;">手动复制数据</h3>
                        <p>请手动选择下面的文本并复制（Ctrl+C）：</p>
                        <textarea readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 8px;">${text}</textarea>
                        <div style="text-align: right; margin-top: 10px;">
                            <button onclick="this.closest('div').parentElement.remove()" style="padding: 8px 16px; background: #644a40; color: white; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // 自动选择文本
            const textarea = modal.querySelector('textarea');
            setTimeout(() => {
                textarea.focus();
                textarea.select();
            }, 100);
        }

        function showCopySuccessNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 14px;">
                    📋 已复制到剪贴板，可粘贴到Excel
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        }

        // 页面加载完成后执行恢复
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                restoreDataOnLoad();
                displayHistory();
                initializeFileInput();
            }, 100);
        });

        // 存储上传的文件
        let uploadedFiles = [];

        // 初始化文件输入监听器
        function initializeFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelection);
        }

        // 处理文件选择
        function handleFileSelection(event) {
            const newFiles = Array.from(event.target.files);

            // 检查重复文件名，避免添加相同的文件
            newFiles.forEach(newFile => {
                const isDuplicate = uploadedFiles.some(existingFile =>
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                );

                if (!isDuplicate) {
                    uploadedFiles.push(newFile);
                }
            });

            // 清空文件输入框，允许重新选择相同文件
            event.target.value = '';

            displayFileList();
        }

        // 显示文件列表
        function displayFileList() {
            const fileListDiv = document.getElementById('fileList');
            const analyzeAllBtn = document.getElementById('analyzeAllBtn');
            const copyAllBtn = document.getElementById('copyAllBtn');

            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '';
                analyzeAllBtn.style.display = 'none';
                copyAllBtn.style.display = 'none';
                return;
            }

            analyzeAllBtn.style.display = 'inline-block';
            copyAllBtn.style.display = 'none'; // 只有分析完成后才显示

            fileListDiv.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-item" style="border: 1px solid #d8d8d8; border-radius: 6px; padding: 12px; margin-bottom: 8px; background: #fcfcfc;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #644a40; font-size: 14px;">${file.name}</strong>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn" onclick="removeFile(${index})" style="background: #dc3545; font-size: 12px; padding: 4px 8px;">移除</button>
                            <button class="btn" onclick="viewFileDetails(${index})" id="detailBtn-${index}" style="background: #ccc; font-size: 12px; padding: 4px 8px;" disabled>查看详情</button>
                        </div>
                    </div>
                    <textarea class="supplement-input" data-file-index="${index}" placeholder="为此文件输入补充信息（关键词信息和SERP链接数据）..." style="width: 100%; height: 60px; padding: 8px; border: 1px solid #d8d8d8; border-radius: 4px; font-size: 13px; resize: vertical;"></textarea>
                </div>
            `).join('');
        }

        // 移除指定文件
        function removeFile(index) {
            if (index >= 0 && index < uploadedFiles.length) {
                uploadedFiles.splice(index, 1);

                // 如果有分析结果，也要移除对应的结果
                if (allAnalysisResults.length > index) {
                    allAnalysisResults.splice(index, 1);
                }

                displayFileList();
            }
        }

        // 存储所有分析结果
        let allAnalysisResults = [];

        // 批量分析所有文件
        async function analyzeAllFiles() {
            if (uploadedFiles.length === 0) {
                alert('请先上传文件');
                return;
            }

            allAnalysisResults = [];
            const analyzeAllBtn = document.getElementById('analyzeAllBtn');
            const originalText = analyzeAllBtn.textContent;

            try {
                analyzeAllBtn.textContent = '分析中...';
                analyzeAllBtn.disabled = true;

                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    const supplementInput = document.querySelector(`textarea[data-file-index="${i}"]`);
                    const supplementData = supplementInput ? supplementInput.value.trim() : '';

                    analyzeAllBtn.textContent = `分析中... (${i + 1}/${uploadedFiles.length})`;

                    try {
                        // 分析单个文件
                        const analysis = await analyzeFileContent(file);

                        // 解析补充信息
                        let supplementInfo = null;
                        if (supplementData) {
                            supplementInfo = parseKeywordAndSerpData(supplementData);
                        }

                        allAnalysisResults.push({
                            fileName: file.name,
                            analysis: analysis,
                            supplementInfo: supplementInfo
                        });

                    } catch (error) {
                        console.error(`分析文件 ${file.name} 时出错:`, error);
                        allAnalysisResults.push({
                            fileName: file.name,
                            analysis: null,
                            supplementInfo: null,
                            error: error.message
                        });
                    }
                }

                analyzeAllBtn.textContent = '分析完成';
                const copyAllBtn = document.getElementById('copyAllBtn');
                copyAllBtn.style.display = 'inline-block'; // 分析完成后显示复制按钮

                // 启用所有详情按钮
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const detailBtn = document.getElementById(`detailBtn-${i}`);
                    if (detailBtn) {
                        detailBtn.disabled = false;
                        detailBtn.style.background = '#666';
                    }
                }

                setTimeout(() => {
                    analyzeAllBtn.textContent = originalText;
                    analyzeAllBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('批量分析出错:', error);
                analyzeAllBtn.textContent = originalText;
                analyzeAllBtn.disabled = false;
                alert('批量分析出错: ' + error.message);
            }
        }

        // 分析单个文件内容
        async function analyzeFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const htmlContent = e.target.result;
                        const analysis = analyzePage(htmlContent, file.name);
                        resolve(analysis);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };
                reader.readAsText(file);
            });
        }

        // 批量复制到Excel
        function copyAllToExcel() {
            if (allAnalysisResults.length === 0) {
                alert('请先分析文件');
                return;
            }

            try {
                const headers = [
                    '文件名', '关键词', 'URL', '获得流量', '搜索结果数量', 'Intitle', 'KD难度', 'KGR',
                    '页面标题', '页面描述', 'H1', 'H2', '单词数',
                    '1词', '2词', '3词', '4词',
                    'SERP竞争分析标题', 'SERP竞争分析网址'
                ];

                const dataRows = allAnalysisResults.map(result => {
                    if (result.error) {
                        return [result.fileName, '分析失败', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
                    }

                    const { fileName, analysis, supplementInfo } = result;
                    const dataRow = [];

                    dataRow.push(fileName); // 文件名

                    // 关键词指标
                    if (supplementInfo && supplementInfo.keywordInfo) {
                        const kw = supplementInfo.keywordInfo;
                        dataRow.push(kw.keyword || ''); // 关键词
                        dataRow.push(kw.url || ''); // URL
                        dataRow.push(kw.traffic || ''); // 获得流量
                        dataRow.push(kw.results || ''); // 搜索结果数量
                        dataRow.push(kw.intitle || ''); // Intitle
                        dataRow.push(kw.difficulty || ''); // KD难度
                        dataRow.push(calculateKGR(kw.intitle, kw.results)); // KGR
                    } else {
                        dataRow.push('', '', '', '', '', '', ''); // 空的关键词指标
                    }

                    // 页面信息
                    dataRow.push(analysis.title || ''); // 页面标题
                    dataRow.push(analysis.description || ''); // 页面描述

                    // H标签
                    const h1Tags = analysis.headings?.filter(h => h.level === 1).map(h => h.text).join('; ') || '';
                    const h2Tags = analysis.headings?.filter(h => h.level === 2).map(h => h.text).join('; ') || '';
                    dataRow.push(h1Tags); // H1
                    dataRow.push(h2Tags); // H2

                    // 单词数
                    dataRow.push(analysis.wordCount || '0'); // 单词数

                    // 关键词密度（按词数分组）
                    const keywords1 = analysis.keywords?.single?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                    const keywords2 = analysis.keywords?.double?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                    const keywords3 = analysis.keywords?.triple?.map(k => `${k.word}(${k.count})`).join('; ') || '';
                    const keywords4 = analysis.keywords?.quadruple?.map(k => `${k.word}(${k.count})`).join('; ') || '';

                    dataRow.push(keywords1); // 1词
                    dataRow.push(keywords2); // 2词
                    dataRow.push(keywords3); // 3词
                    dataRow.push(keywords4); // 4词

                    // SERP竞争分析
                    if (supplementInfo && supplementInfo.serpLinks && supplementInfo.serpLinks.length > 0) {
                        const serpTitles = supplementInfo.serpLinks.map(link => link.title).join('; ');
                        const serpUrls = supplementInfo.serpLinks.map(link => link.url).join('; ');
                        dataRow.push(serpTitles); // SERP竞争分析标题
                        dataRow.push(serpUrls); // SERP竞争分析网址
                    } else {
                        dataRow.push('', ''); // 空的SERP数据
                    }

                    return dataRow;
                });

                const excelData = [headers, ...dataRows];

                // 转换为制表符分隔的格式
                const tsvContent = excelData.map(row => row.join('\t')).join('\n');

                // 复制到剪贴板
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(tsvContent).then(() => {
                        showCopySuccessNotification('批量数据已复制到剪贴板');
                    }).catch(err => {
                        console.warn('Clipboard API失败，使用fallback:', err);
                        fallbackCopyToClipboard(tsvContent);
                    });
                } else {
                    fallbackCopyToClipboard(tsvContent);
                }

            } catch (error) {
                console.error('批量复制到Excel失败:', error);
                alert('复制失败：' + error.message);
            }
        }

        function showCopySuccessNotification(message) {
            // 创建一个临时的成功提示
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // 查看单个文件的详情
        function viewFileDetails(fileIndex) {
            if (fileIndex >= uploadedFiles.length) {
                alert('文件索引错误');
                return;
            }

            if (allAnalysisResults.length === 0) {
                alert('请先点击"分析全部"进行分析');
                return;
            }

            const result = allAnalysisResults[fileIndex];
            if (!result) {
                alert('该文件的分析结果不存在，请重新分析');
                return;
            }

            if (result.error) {
                alert(`分析文件 ${result.fileName} 时出错: ${result.error}`);
                return;
            }

            // 临时保存当前的分析结果，然后使用原有的显示逻辑
            const originalResults = document.getElementById('results');
            const isResultsVisible = originalResults.style.display !== 'none';

            // 显示结果并使用原有的 displayResults 函数
            displayResults(result.analysis, result.supplementInfo);

            // 如果原来结果区域是隐藏的，现在临时显示
            if (!isResultsVisible) {
                originalResults.style.display = 'block';

                // 添加一个临时的返回按钮
                const backButton = document.createElement('div');
                backButton.id = 'tempBackButton';
                backButton.innerHTML = `
                    <div style="text-align: center; margin: 20px 0; padding: 16px; background: #f0f0f0; border-radius: 8px;">
                        <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">正在查看: <strong>${result.fileName}</strong></p>
                        <button onclick="closeTempDetailView()" style="background: #644a40; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">返回文件列表</button>
                    </div>
                `;
                originalResults.insertBefore(backButton, originalResults.firstChild);
            }
        }

        // 关闭临时详情查看
        function closeTempDetailView() {
            const tempButton = document.getElementById('tempBackButton');
            if (tempButton) {
                tempButton.remove();
            }

            const originalResults = document.getElementById('results');
            originalResults.style.display = 'none';
        }


        // CORS代理服务列表
        const proxyUrls = [
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://cors-anywhere.herokuapp.com/',
            'https://crossorigin.me/',
            'https://api.allorigins.win/get?url='
        ];

        async function fetchPageContent(url, timeout = 12000) {
            const encodedUrl = encodeURIComponent(url);

            for (let i = 0; i < proxyUrls.length; i++) {
                try {
                    console.log(`尝试使用代理 ${i + 1}: ${proxyUrls[i]}`);

                    // 创建带超时的fetch请求
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    let proxyUrl, response;

                    if (proxyUrls[i].includes('allorigins')) {
                        proxyUrl = `${proxyUrls[i]}${encodedUrl}`;
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const data = await response.json();
                            return {
                                text: () => Promise.resolve(data.contents),
                                ok: true,
                                status: 200
                            };
                        }
                    } else if (proxyUrls[i].includes('codetabs')) {
                        proxyUrl = `${proxyUrls[i]}${encodedUrl}`;
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            return response;
                        }
                    } else if (proxyUrls[i].includes('thingproxy')) {
                        proxyUrl = `${proxyUrls[i]}${url}`;  // thingproxy不需要编码
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            return response;
                        }
                    } else if (proxyUrls[i].includes('cors-anywhere')) {
                        proxyUrl = `${proxyUrls[i]}${url}`;  // cors-anywhere不需要编码
                        response = await fetch(proxyUrl, {
                            signal: controller.signal,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            return response;
                        }
                    } else if (proxyUrls[i].includes('crossorigin')) {
                        proxyUrl = `${proxyUrls[i]}${url}`;  // crossorigin.me不需要编码
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            return response;
                        }
                    } else {
                        // 其他代理
                        proxyUrl = `${proxyUrls[i]}${encodedUrl}`;
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            return response;
                        }
                    }
                } catch (error) {
                    console.warn(`代理 ${i + 1} 失败:`, error.name === 'AbortError' ? '超时' : error.message);
                    if (i === proxyUrls.length - 1) {
                        throw new Error(`所有代理都失败了。最后一个错误: ${error.message}`);
                    }
                }
            }
        }

        async function batchDownloadSerpUrls() {
            if (!globalSerpLinks || globalSerpLinks.length === 0) {
                showError('没有可下载的SERP链接');
                return;
            }

            const progressDiv = document.getElementById('serpProgress');
            progressDiv.style.display = 'block';

            const progressFill = document.getElementById('serpProgressFill');
            const progressText = document.getElementById('serpProgressText');
            const progressCount = document.getElementById('serpProgressCount');
            const progressDetails = document.getElementById('serpProgressDetails');

            let completed = 0;
            let successful = 0;
            const urls = globalSerpLinks.map(link => link.url);

            progressCount.textContent = `0/${urls.length}`;
            progressDetails.innerHTML = '';

            try {
                progressText.textContent = `开始并发下载 ${urls.length} 个链接...`;

                // 创建所有下载任务
                const downloadTasks = urls.map(async (url, i) => {
                    try {
                        const response = await fetchPageContent(url, 12000); // 12秒超时
                        const html = await response.text();

                        const urlObj = new URL(url);
                        const filename = `${urlObj.hostname}.html`;

                        downloadHTML(html, filename);
                        return { url, status: 'success', filename };
                    } catch (error) {
                        console.error(`下载失败 ${url}:`, error);
                        return { url, status: 'failed', error: error.message };
                    }
                });

                // 等待所有任务完成，并实时更新进度
                const results = [];
                for (let taskIndex = 0; taskIndex < downloadTasks.length; taskIndex++) {
                    const task = downloadTasks[taskIndex];
                    const result = await task;
                    results.push(result);
                    completed++;

                    if (result.status === 'success') {
                        successful++;
                        progressDetails.innerHTML += `<div style="color: #644a40;">✓ ${result.url}</div>`;

                        // 在SERP表格中添加✓标记
                        const statusElement = document.getElementById(`download-status-${taskIndex}`);
                        if (statusElement) {
                            statusElement.textContent = '✓';
                            statusElement.title = '已下载';
                        }
                    } else {
                        progressDetails.innerHTML += `<div style="color: #e54d2e;">✗ ${result.url} (${result.error})</div>`;

                        // 在SERP表格中添加✗标记
                        const statusElement = document.getElementById(`download-status-${taskIndex}`);
                        if (statusElement) {
                            statusElement.textContent = '✗';
                            statusElement.style.color = '#dc3545';
                            statusElement.title = '下载失败';
                        }
                    }

                    progressCount.textContent = `${completed}/${urls.length}`;
                    progressFill.style.width = `${(completed / urls.length) * 100}%`;
                    progressText.textContent = `已完成: ${completed}/${urls.length}`;
                }

                progressText.textContent = `SERP链接下载完成！成功: ${successful}个`;

                // 播放完成声音并隐藏进度条
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);

            } catch (error) {
                showError('SERP链接批量下载失败: ' + error.message);
            }
        }

        function copyAllUrls() {
            if (globalSerpLinks.length === 0) {
                return;
            }

            const urls = globalSerpLinks.map(link => link.url).join('\n');

            // 使用Clipboard API复制到剪贴板
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(urls).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(urls);
                });
            } else {
                // 备用方案
                fallbackCopyTextToClipboard(urls);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('复制失败:', err);
            }

            document.body.removeChild(textArea);
        }

    </script>
</body>
</html>